

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Worker init and exit &mdash; mpire 2.10.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/banner.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/sphinxcontrib-images/LightBox2/lightbox2/css/lightbox.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
        <script src="../../_static/sphinxcontrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
        <script src="../../_static/sphinxcontrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
        <script src="../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Task chunking" href="task_chunking.html" />
    <link rel="prev" title="Progress bar" href="progress_bar.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> mpire
          

          
          </a>

          
            
            
              <div class="version">
                2.10.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Welcome to the MPIRE documentation!</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting started</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Usage</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../workerpool/index.html">WorkerPool</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Map family</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="map.html">map family of functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="progress_bar.html">Progress bar</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Worker init and exit</a></li>
<li class="toctree-l3"><a class="reference internal" href="task_chunking.html">Task chunking</a></li>
<li class="toctree-l3"><a class="reference internal" href="max_tasks_active.html">Maximum number of active tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="worker_lifespan.html">Worker lifespan</a></li>
<li class="toctree-l3"><a class="reference internal" href="timeouts.html">Timeouts</a></li>
<li class="toctree-l3"><a class="reference internal" href="numpy.html">Numpy arrays</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../apply.html">Apply family</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dashboard.html">Dashboard</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contribution guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">mpire</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Usage</a> &raquo;</li>
        
          <li><a href="index.html">Map family</a> &raquo;</li>
        
      <li>Worker init and exit</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/usage/map/worker_init_exit.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="worker-init-and-exit">
<span id="worker-init-exit"></span><h1>Worker init and exit<a class="headerlink" href="#worker-init-and-exit" title="Permalink to this headline">¶</a></h1>
<p>When you want to initialize a worker you can make use of the <code class="docutils literal notranslate"><span class="pre">worker_init</span></code> parameter of any <code class="docutils literal notranslate"><span class="pre">map</span></code> function. This
will call the initialization function only once per worker. Similarly, if you need to clean up the worker at the end of
its lifecycle you can use the <code class="docutils literal notranslate"><span class="pre">worker_exit</span></code> parameter. Additionally, the exit function can return anything you like,
which can be collected using <a class="reference internal" href="../../reference/index.html#mpire.WorkerPool.get_exit_results" title="mpire.WorkerPool.get_exit_results"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mpire.WorkerPool.get_exit_results()</span></code></a> after the workers are done.</p>
<p>Both init and exit functions receive the worker ID, shared objects, and worker state in the same way as the task
function does, given they’re enabled.</p>
<p>For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">init_func</span><span class="p">(</span><span class="n">worker_state</span><span class="p">):</span>
    <span class="c1"># Initialize a counter for each worker</span>
    <span class="n">worker_state</span><span class="p">[</span><span class="s1">&#39;count_even&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">square_and_count_even</span><span class="p">(</span><span class="n">worker_state</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1"># Count number of even numbers and return the square</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">worker_state</span><span class="p">[</span><span class="s1">&#39;count_even&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">exit_func</span><span class="p">(</span><span class="n">worker_state</span><span class="p">):</span>
    <span class="c1"># Return the counter</span>
    <span class="k">return</span> <span class="n">worker_state</span><span class="p">[</span><span class="s1">&#39;count_even&#39;</span><span class="p">]</span>

<span class="k">with</span> <span class="n">WorkerPool</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">use_worker_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">square_and_count_even</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">worker_init</span><span class="o">=</span><span class="n">init_func</span><span class="p">,</span> <span class="n">worker_exit</span><span class="o">=</span><span class="n">exit_func</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">get_exit_results</span><span class="p">())</span>  <span class="c1"># Output, e.g.: [13, 13, 12, 12]</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">get_exit_results</span><span class="p">()))</span>  <span class="c1"># Output: 50</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">worker_lifespan</span></code> option is used to restart workers during execution, the exit function will be called
for the worker that’s shutting down and the init function will be called again for the new worker. Therefore, the
number of elements in the list that’s returned from <a class="reference internal" href="../../reference/index.html#mpire.WorkerPool.get_exit_results" title="mpire.WorkerPool.get_exit_results"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mpire.WorkerPool.get_exit_results()</span></code></a> does not always equal
<code class="docutils literal notranslate"><span class="pre">n_jobs</span></code>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>When <code class="docutils literal notranslate"><span class="pre">keep_alive</span></code> is enabled the workers won’t be terminated after a <code class="docutils literal notranslate"><span class="pre">map</span></code> call. This means the exit function
won’t be called until it’s time for cleaning up the entire pool. You will have to explicitly call
<a class="reference internal" href="../../reference/index.html#mpire.WorkerPool.stop_and_join" title="mpire.WorkerPool.stop_and_join"><code class="xref py py-meth docutils literal notranslate"><span class="pre">mpire.WorkerPool.stop_and_join()</span></code></a> to receive the exit results.</p>
</div>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="task_chunking.html" class="btn btn-neutral float-right" title="Task chunking" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="progress_bar.html" class="btn btn-neutral float-left" title="Progress bar" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2024, Sybren Jansen

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: master
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../../v1.1.2/index.html">v1.1.2</a></dd>
            <dd><a href="../../../v1.1.3/index.html">v1.1.3</a></dd>
            <dd><a href="../../../v1.2.0/index.html">v1.2.0</a></dd>
            <dd><a href="../../../v1.2.1/index.html">v1.2.1</a></dd>
            <dd><a href="../../../v1.2.2/index.html">v1.2.2</a></dd>
            <dd><a href="../../../v2.0.0/index.html">v2.0.0</a></dd>
            <dd><a href="../../../v2.1.0/index.html">v2.1.0</a></dd>
            <dd><a href="../../../v2.1.1/index.html">v2.1.1</a></dd>
            <dd><a href="../../../v2.10.0/usage/map/worker_init_exit.html">v2.10.0</a></dd>
            <dd><a href="../../../v2.10.1/usage/map/worker_init_exit.html">v2.10.1</a></dd>
            <dd><a href="../../../v2.2.0/index.html">v2.2.0</a></dd>
            <dd><a href="../../../v2.2.1/index.html">v2.2.1</a></dd>
            <dd><a href="../../../v2.3.0/usage/map/worker_init_exit.html">v2.3.0</a></dd>
            <dd><a href="../../../v2.3.1/usage/map/worker_init_exit.html">v2.3.1</a></dd>
            <dd><a href="../../../v2.3.2/usage/map/worker_init_exit.html">v2.3.2</a></dd>
            <dd><a href="../../../v2.3.3/usage/map/worker_init_exit.html">v2.3.3</a></dd>
            <dd><a href="../../../v2.3.4/usage/map/worker_init_exit.html">v2.3.4</a></dd>
            <dd><a href="../../../v2.3.5/usage/map/worker_init_exit.html">v2.3.5</a></dd>
            <dd><a href="../../../v2.4.0/usage/map/worker_init_exit.html">v2.4.0</a></dd>
            <dd><a href="../../../v2.5.0/usage/map/worker_init_exit.html">v2.5.0</a></dd>
            <dd><a href="../../../v2.6.0/usage/map/worker_init_exit.html">v2.6.0</a></dd>
            <dd><a href="../../../v2.7.0/usage/map/worker_init_exit.html">v2.7.0</a></dd>
            <dd><a href="../../../v2.7.1/usage/map/worker_init_exit.html">v2.7.1</a></dd>
            <dd><a href="../../../v2.8.0/usage/map/worker_init_exit.html">v2.8.0</a></dd>
            <dd><a href="../../../v2.8.1/usage/map/worker_init_exit.html">v2.8.1</a></dd>
            <dd><a href="../../../v2.9.0/usage/map/worker_init_exit.html">v2.9.0</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="worker_init_exit.html">master</a></dd>
        </dl>
    </div>
</div>


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>